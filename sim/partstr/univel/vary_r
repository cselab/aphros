#!/bin/bash

set -ue

# output folder
o=o
rm -vf $o/*.pdf
mkdir -p $o

: ${bc="0.31 0.29 0.26 "} # bubble center
: ${vel="0.4 0.3 0.2 "} # velocity
: ${tosc="3"} # number of shape n=2 oscillations
: ${la="7200"}  # laplace number
: ${lexp="0 1 2 3 4"}  # list of exponents for radius: r/h = 2 ** (exp/2)
: ${mu=0.01}   # viscosity
: ${rho=1}    # density
: ${bryk=1}   # factor for bry
: ${nxexp=4}    # exponent for mesh size, nx = 2 ** nxexp

# log
l="out"
echo > $l

echo "lexp=$lexp"
echo "vel=$vel"
echo "mu=$mu"
echo "rho=$rho"
echo "la=$la"
echo "tosc=$tosc"

for exp in $lexp ; do
  # mesh size
  nx=`bc -l <<< "2 ^ $nxexp"`
  # mesh step
  hx=`bc -l <<< "1. / $nx"`
  # bubble radius
  br=`bc -l <<< "$hx * sqrt(2 ^ $exp)"`

  # surface tesnion
  sig=`bc -l <<< "$la * $mu * $mu / (2. * $br * $rho)"` 

  n=2
  om=`bc -l <<< "sqrt(($n ^ 3 - $n) * $sig / (2. * $rho * ($br ^ 3)))"`
  tmax=`bc -l <<< "$tosc * 3.1415926 * 2 / $om"`
  #tmax=`bc -l <<< "$ttmax * $mu * 2. * $br / $sig"`

  # write config
  bry=`bc -l <<< "$br * $bryk"`
  echo "$bc $br $bry $br" > b.dat
  echo "$vel" > vel
  echo "$tmax" > tmax
  echo "$sig" > sig
  echo "$mu" > mu
  echo "$nxexp" > nxexp

  # print config
  echo "$bc $br $bry $br" 
  echo "br=$br"
  echo "sig=$sig"
  echo "tmax=$tmax"
  echo "nxexp=$nxexp"

  p="r${br}_" # prefix for output

  # run ch
  d="ch"
  echo $d
  (cd $d ; ./run) &>> $l

  # run ge
  d="ge"
  echo $d
  (cd $d ; ./run) &>> $l

  # plot cmp
  ./plot.py &>> $l

  d="ch"
  mv -f $d/vf_0000.pdf $o/${p}vf_$d.pdf
  d="ge"
  mv -f $d/vf_0000.pdf $o/${p}vf_$d.pdf
  for f in `ls {traj,trajp,trajx,trajy,trajz,trajvxm,trajvym,trajvzm,trajvx2,trajvy2,trajvz2}.pdf` ; do
    mv -v $f $o/${p}${f}
  done

done

# tile all pdf
(cd $o ; ../tile)

mv -v out $o/

# rename folder
IFS=' ' read velx vely velz <<< "$vel"
dout=${o}_vel${velx}_t${tosc}_nx${nx}
echo $dout
rm -rf $dout
mv -T $o $dout
