#!/bin/bash

set -ue

# output folder
o=o
rm -vf $o/*.{pdf,png}
mkdir -p $o

# bubble
: ${bc="0.51 0.49 0.56 "}

# rx/ry ratio
: ${k=1}
echo k=$k

# rx/rz ratio
: ${kz=1}
echo kz=$kz

# log
l="out"
echo > $l

# error
e="err"
echo > $e

for exp in `seq 0 9` ; do
#for exp in 2 4 6 8 ; do
  br=`bc -l <<< "0.4 * sqrt(2 ^ (-$exp))"`
  brx=`bc -l <<< "$br"`
  bry=`bc -l <<< "$br / $k"`
  brz=`bc -l <<< "$br / $kz"`
  echo "brx=$brx, bry=$bry, brz=$brz"
  echo "$bc $brx $bry $brz" > b.dat
  p="r${br}_"

  # run ch
  d="ch"
  (cd $d ; ./run) &>> $l

  # run ge
  d="ge"
  (cd $d ; ./run) &>> $l

  # plot cmp
  ./plot.py &>> $l

  # append error
  cat er >> $e

  d="ch"
  mv -f $d/vf_0000.pdf $o/${p}vf_$d.pdf
  [ -f $d/s.png ] && mv -v $d/s.png $o/${p}s.png
  d="ge"
  mv -f $d/vf_0001.pdf $o/${p}vf_$d.pdf
  mv -v hist.pdf $o/${p}hist.pdf
  [ -f ang.pdf ] && mv -v ang.pdf $o/${p}ang.pdf
done


mv -v out $o/

gnuplot a.gp
mv -v err $o/
mv -v er*.pdf $o/

# tile all pdf
(cd $o ; ../tile)

# rename folder
d=${o}_${k}_${kz}
rm -rf $d
mv -T $o $d
