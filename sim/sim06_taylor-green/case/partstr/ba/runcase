#!/bin/bash

set -eu

ev () {
  echo "$@"
  eval "$@"
}

eval "$@"

: ${nx=064}
: ${partstr=1}
: ${learn=0}
: ${np=64}
: ${tl=1440}
: ${suff=}
: ${force=0}
: ${noio=0}

o="nx${nx}_partstr${partstr}"
[ "$learn" == "1" ] && o="${o}_learn"
o="${o}${suff}"
d=dummy

if [ -d "$o" ] && [ "$force" != "1" ] ; then
  echo "skip existing $o"
  exit 1
fi

echo "Output to $o"

ev "rsync -aL $d/ $o"

p=$o/par.h


> $p
nx=`bc <<< "$nx"`
ev "echo '// generated by \"$0 $@\"' >> $p"
ev "echo '#define NX $nx' >> $p"
ev "echo '#define NOIO $noio' >> $p"
[ "$learn" == "1" ] && ev "echo '#define CURV_LEARN' >> $p"
[ "$partstr" == "1" ] && ev "echo '#define CURV_PARTSTR' >> $p"
[ "$partstr" == "0" ] && [ "$learn" == "0" ] && ev "echo '#define CURV_FIX' >> $p"
ev "cat par.h >> $p"
ev "echo $np > $o/np"
ev "echo $tl > $o/tl"
