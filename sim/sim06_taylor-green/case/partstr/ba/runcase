#!/bin/bash

set -eu

ev () {
  echo "$@"
  eval "$@"
}

eval "$@"

: ${nx=064}
: ${partstr=1}
: ${np=64}
: ${tl=1440}
: ${suff=}
: ${force=0}
: ${noio=0}

o="nx${nx}_partstr${partstr}${suff}"
d=dummy

if [ -d "$o" && ! "$force" != "1" ] ; then
  echo "skip existing $o"
  exit 1
fi

echo "Output to $o"

ev "rsync -aL $d/ $o"

p=$o/par.h

> $p
nx=`bc <<< "$nx"`
ev "echo '// generated by \"$0 $@\"' >> $p"
ev "echo '#define NX $nx' >> $p"
ev "echo '#define PARTSTR $partstr' >> $p"
ev "echo '#define NOIO $noio' >> $p"
ev "cat par.h >> $p"
ev "echo $np > $o/np"
ev "echo $tl > $o/tl"
