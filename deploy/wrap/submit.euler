#!/bin/bash

# Submit job found as ap.job in PATH,
# read number of tasts from np
# read time limit in minutes from tl

set -eu

if [ -f job.id ]; then
  echo "Abort, job.id exists"
  exit 1
fi

ap.writearg "$@"

: ${JOB=ap.job}
job="`type -p $JOB`"

np=`cat np`
tl=`cat tl`
nth=${OMP_NUM_THREADS:-1}

if (( $np % $nth != 0 )) ; then
  echo "Abort, np=$np must be divisible by OMP_NUM_THREADS=$nth"
  exit 1
fi

name="$(basename $(pwd))"

extra=

if [[ "$nth" != 1 ]] ; then
  extra="-R 'span[ptile=$nth]'"
fi

cmd="bsub -J '$name' -n '$np' -W '$tl' $extra < $job"
echo $cmd

msg=`eval $cmd`
echo "$msg"

id=`echo "$msg" | sed -e "s/[^0-9]*<\([0-9]*\)>.*/\1/"`
echo "Write $id to job.id"
echo $id > job.id

echo "pending" > job.status
