#!/bin/bash -l

# Run with arguments from arg on number of tasks from np

set -eu

# run command with time and append to out
rt () {
  echo
  set -o pipefail 
  c="( time $@ ) |& tee -a out"
  echo $c
  eval "$c"
}

argfirst () {
  echo "$1"
}

argrest () {
  shift
  echo "$@"
}

# read arg
if [ -f arg ] ; then
  a="`cat arg`"
else
  a=
fi
# executable
e=`argfirst $a`
# args
a=`argrest $a`
# num tasks
np=`cat np`

js="job.status"

echo running > $js

rm -rf out

[[ -f pre ]] && rt "./pre"

rt "mpirun -n $np $e $a"

[[ -f post ]] && rt "./post"

mv -vf job.id{,.last}

echo "done" > $js

cat $js

