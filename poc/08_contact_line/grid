#!/bin/sh

me=grid
msg () { echo >&2 "$@" ; }
err () { msg "$me: $@"; exit 2 ; }

usg () {
    cat <<!
$me -r ratio -p degree > vtk
!
exit 2
}

Rflag=0 Pflag=0
while test $# -ne 0
do case "$1" in
       -h) usg ;;
       -r) shift
           if test $# -eq 0; then err '-r needs an argument'; fi
           r=$1; shift; Rflag=1 ;;
       -p) shift
           if test $# -eq 0; then err '-p needs an argument'; fi
           p=$1; shift; Pflag=1 ;;
       *) err "unknown argument '$1'" ;;
   esac
done

if test $Rflag -eq 0; then err '-r is not set'; fi
if test $Pflag -eq 0; then err '-p is not set'; fi

tmp=/tmp/grid.$$
trap 'rm -f $tmp; exit 2' 1 2 3 14 15

awk -v r="$r" -v p="$p" -v tmp=$tmp '
BEGIN {
    ox = -0.5
    oy = 0
    sx = 0.005
    sy = 0.005
    nx = 200
    ny = 100
    cmd = "./main -r %.16g -p %.16g > " tmp
    cmd = sprintf(cmd, r, p)
    for (j = 0; j < ny; j++)
        for (i = 0; i < nx; i++) {
            x = ox + sx * i
            y = oy + sy * j
            print x, y | cmd
        }
    close(cmd)
    i = 0
    while ((getline < tmp) == 1) {
        vx[i] = $1
        vy[i] = $2
        pressure[i] = $3
        psi[i] = $4
        i++
    }
    print "# vtk DataFile Version 2.0"
    print "generated by hydro"
    print "ASCII"
    print "DATASET STRUCTURED_POINTS"
    printf "DIMENSIONS %d %d 1\n", nx, ny
    printf "ORIGIN %.16g %.16g 0\n", ox, oy
    printf "SPACING %.16g %.16g 0\n", sx, sy
    printf "POINT_DATA %d\n", nx * ny
    print "VECTORS v double"
    for (i = 0; i < nx * ny; i++)
        print vx[i], vy[i], 0
    print "SCALARS psi double"
    print "LOOKUP_TABLE default"
    for (i = 0; i < nx * ny; i++)
        print psi[i]
    print "SCALARS pressure double"
    print "LOOKUP_TABLE default"
    for (i = 0; i < nx * ny; i++)
        print pressure[i]
}
'

rm -f $tmp
